name: infra-apply-from-plan

on:
  workflow_run:
    workflows: ["infra-plan"]
    types: [completed]

permissions:
  contents: read
  actions: read

concurrency:
  group: infra-apply
  cancel-in-progress: false

jobs:
  apply:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    environment: apply
    defaults:
      run:
        working-directory: infra/terraform
        shell: bash

    env:
      TF_IN_AUTOMATION: "true"
      TF_INPUT: "false"
      TF_CLI_ARGS_init: "-no-color"
      TF_CLI_ARGS_apply: "-no-color"
      TF_CLI_ARGS_validate: "-no-color"

      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

    steps:
      - name: Checkout (same commit SHA)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
          terraform_wrapper: false

      - name: Terraform Init (remote state)
        run: terraform init -backend-config=envs/aks/backend.hcl

      - name: Terraform Validate
        run: terraform validate

      - name: Debug workflow_run pointers
        run: |
          echo "workflow_run.id = ${{ github.event.workflow_run.id }}"
          echo "head_sha        = ${{ github.event.workflow_run.head_sha }}"
          echo "head_branch     = ${{ github.event.workflow_run.head_branch }}"

      - name: List artifacts from plan run (API)
        uses: actions/github-script@v7
        with:
          script: |
            const run_id = context.payload.workflow_run.id;
            const { owner, repo } = context.repo;
            const res = await github.rest.actions.listWorkflowRunArtifacts({ owner, repo, run_id });
            core.info(`Artifacts for run ${run_id}:`);
            for (const a of res.data.artifacts) {
              core.info(`- name="${a.name}"  id=${a.id}  expired=${a.expired}`);
            }

      - name: Download plan artifact from Plan run
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-${{ github.event.workflow_run.head_sha }}
          run-id: ${{ github.event.workflow_run.id }}
          path: infra/terraform

      - name: Terraform Apply (from saved tfplan)
        run: |
          set -euo pipefail
          PLAN_FILE="tfplan-${{ github.event.workflow_run.head_sha }}"
          test -f "${PLAN_FILE}"
          terraform apply -auto-approve "${PLAN_FILE}"
