name: infra-apply-from-plan

on:
  workflow_run:
    workflows: ["infra-plan"]
    types: [completed]

permissions:
  contents: read
  actions: read

concurrency:
  group: infra-apply
  cancel-in-progress: false

jobs:
  apply:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    environment: apply
    defaults:
      run:
        working-directory: infra/terraform
        shell: bash

    env:
      TF_IN_AUTOMATION: "true"
      TF_INPUT: "false"
      TF_CLI_ARGS_init: "-no-color"
      TF_CLI_ARGS_apply: "-no-color"
      TF_CLI_ARGS_validate: "-no-color"

      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

    steps:
      - name: Checkout (same commit SHA)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
          terraform_wrapper: false

      - name: Terraform Init (remote state)
        run: terraform init -backend-config=envs/aks/backend.hcl

      - name: Terraform Validate
        run: terraform validate

      - name: Debug workflow_run pointers
        run: |
          echo "workflow_run.id = ${{ github.event.workflow_run.id }}"
          echo "head_sha        = ${{ github.event.workflow_run.head_sha }}"
          echo "head_branch     = ${{ github.event.workflow_run.head_branch }}"

      - name: List artifacts from plan run (API)
        uses: actions/github-script@v7
        with:
          script: |
            const run_id = context.payload.workflow_run.id;
            const { owner, repo } = context.repo;
            const res = await github.rest.actions.listWorkflowRunArtifacts({ owner, repo, run_id });
            core.info(`Artifacts for run ${run_id}:`);
            for (const a of res.data.artifacts) {
              core.info(`- name="${a.name}"  id=${a.id}  expired=${a.expired}`);
            }

      - name: Get artifact id from plan run (API)
        id: artifact
        uses: actions/github-script@v7
        with:
          script: |
            const run_id = context.payload.workflow_run.id;
            const { owner, repo } = context.repo;

            const res = await github.rest.actions.listWorkflowRunArtifacts({ owner, repo, run_id });
            const expectedName = `terraform-plan-${context.payload.workflow_run.head_sha}`;

            const found = res.data.artifacts.find(a => a.name === expectedName && !a.expired);
            if (!found) {
              core.setFailed(`Artifact not found or expired. Expected: ${expectedName}`);
              return;
            }

            core.setOutput('artifact_id', String(found.id));
            core.setOutput('artifact_name', found.name);
            core.info(`Using artifact: ${found.name} (id=${found.id})`);

      - name: Download artifact by id (zip) and extract
        run: |
          set -euo pipefail
          ARTIFACT_ID="${{ steps.artifact.outputs.artifact_id }}"
          echo "Downloading artifact id=${ARTIFACT_ID}"

          curl -L \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/${ARTIFACT_ID}/zip" \
            -o artifact.zip

          unzip -o artifact.zip -d .
          rm -f artifact.zip

          echo "Files after extract:"
          ls -la

      - name: Terraform Apply (from saved tfplan)
        run: |
          set -euo pipefail
          PLAN_FILE="tfplan-${{ github.event.workflow_run.head_sha }}"
          test -f "${PLAN_FILE}"
          terraform apply -auto-approve "${PLAN_FILE}"
