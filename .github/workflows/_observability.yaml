name: _observability

on:
  workflow_call:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: [self-hosted, jumpbox]
    defaults:
      run:
        shell: bash

    env:
      AKS_RESOURCE_GROUP: ${{ vars.aks_resource_group }}
      AKS_NAME: ${{ vars.aks_name }}

      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

      GRAFANA_ADMIN_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
      GRAFANA_HOST: ${{ vars.grafana_host }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login (SP)
        run: |
          set -euo pipefail
          az login --service-principal \
            -u "${ARM_CLIENT_ID}" \
            -p "${ARM_CLIENT_SECRET}" \
            --tenant "${ARM_TENANT_ID}" >/dev/null
          az account set --subscription "${ARM_SUBSCRIPTION_ID}"

      - name: AKS credentials (admin)
        run: |
          set -euo pipefail
          rm -f ~/.kube/config || true
          az aks get-credentials \
            --resource-group "${AKS_RESOURCE_GROUP}" \
            --name "${AKS_NAME}" \
            --admin \
            --overwrite-existing

      - name: Apply kube-prometheus (CRDs first)
        run: |
          set -euo pipefail

          # 1) CRDs/setup: N√ÉO use apply (evita last-applied gigante nas annotations)
          kubectl create -f k8s/observability/kube-prometheus/manifests/setup \
            --save-config=false --validate=false || true

          # 2) Espera CRDs registrarem
          kubectl wait --for=condition=Established crd --all --timeout=10m

          # 3) Resto
          kubectl apply -f k8s/observability/kube-prometheus/manifests

      - name: Configure Grafana admin credentials
        run: |
          set -euo pipefail
          test -n "${GRAFANA_ADMIN_PASSWORD}"

          kubectl -n monitoring create secret generic grafana-admin \
            --from-literal=GF_SECURITY_ADMIN_USER=admin \
            --from-literal=GF_SECURITY_ADMIN_PASSWORD="${GRAFANA_ADMIN_PASSWORD}" \
            --dry-run=client -o yaml | kubectl apply -f -

          # Garante env vars no deployment
          kubectl -n monitoring set env deploy/grafana --from=secret/grafana-admin

      - name: Apply Grafana datasources (Prometheus + Loki)
        run: |
          set -euo pipefail

          kubectl -n monitoring delete secret grafana-datasources --ignore-not-found

          kubectl -n monitoring create secret generic grafana-datasources \
            --from-file=datasources.yaml=k8s/observability/extra/grafana/datasources.yaml \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply Grafana dashboard provider (custom)
        run: |
          set -euo pipefail
          kubectl apply -f k8s/observability/extra/grafana/15-grafana-dashboard-provider-and-sidecar.yaml

      - name: Patch Grafana (sidecar + volumes)
        run: |
          set -euo pipefail
          kubectl patch deployment grafana -n monitoring \
            --type=merge \
            --patch-file k8s/observability/extra/grafana/16-grafana-sidecar-patch.yaml

      - name: Restart Grafana to reload provisioning/sidecar
        run: |
          set -euo pipefail
          kubectl -n monitoring rollout restart deploy/grafana
          kubectl -n monitoring rollout status deploy/grafana --timeout=10m

      - name: Clean kube-prometheus default dashboards (ConfigMaps)
        run: |
          set -euo pipefail

          # Remove somente os defaults do kube-prometheus
          kubectl -n monitoring get cm -o name \
            | grep -E '^configmap/grafana-dashboard-' \
            | xargs -r kubectl -n monitoring delete --ignore-not-found

      - name: Apply whoami probe + custom dashboards
        run: |
          set -euo pipefail
          kubectl apply -f k8s/observability/extra/30-whoami-probe.yaml
          kubectl apply -f k8s/observability/dashboards/

      # - name: Restart Grafana (optional) to refresh dashboards list
      #   run: |
      #     set -euo pipefail
      #     kubectl -n monitoring rollout restart deploy/grafana
      #     kubectl -n monitoring rollout status deploy/grafana --timeout=10m

      - name: Apply Grafana Ingress
        run: |
          set -euo pipefail
          kubectl apply -f k8s/observability/extra/20-grafana-ingress.yaml

      - name: Allow ingress-nginx to reach Grafana (NetworkPolicy)
        run: |
          set -euo pipefail
          kubectl apply -f k8s/observability/extra/25-grafana-netpol-allow-ingress-nginx.yaml

      - name: Debug (Grafana + dashboards + datasources)
        run: |
          set -euo pipefail
          kubectl -n monitoring get pods -l app.kubernetes.io/name=grafana -o wide
          kubectl -n monitoring exec -it deploy/grafana -- ls -la /etc/grafana/provisioning/dashboards || true
          kubectl -n monitoring exec -it deploy/grafana -- ls -la /etc/grafana/provisioning/datasources || true
          kubectl -n monitoring exec -it deploy/grafana -- ls -la /var/lib/grafana/dashboards || true
