name: _dns_cloudflare

on:
  workflow_call:

permissions:
  contents: read

concurrency:
  group: dns-cloudflare-sync
  cancel-in-progress: true

jobs:
  sync:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: [self-hosted, jumpbox]
    defaults:
      run:
        shell: bash

    env:
      AKS_RESOURCE_GROUP: ${{ vars.AKS_RESOURCE_GROUP }}
      AKS_NAME: ${{ vars.AKS_NAME }}
      WHOAMI_HOST: ${{ vars.WHOAMI_HOST }}

      CLOUDFLARE_ZONE_ID: ${{ vars.CLOUDFLARE_ZONE_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

    steps:
      - name: Azure login (SP)
        run: |
          set -euo pipefail
          az login --service-principal \
            -u "${ARM_CLIENT_ID}" \
            -p "${ARM_CLIENT_SECRET}" \
            --tenant "${ARM_TENANT_ID}" >/dev/null
          az account set --subscription "${ARM_SUBSCRIPTION_ID}"

      - name: AKS credentials (admin)
        run: |
          set -euo pipefail
          rm -f ~/.kube/config || true
          az aks get-credentials \
            --resource-group "${AKS_RESOURCE_GROUP}" \
            --name "${AKS_NAME}" \
            --admin \
            --overwrite-existing

      - name: Get ingress public IP (origin)
        id: origin
        run: |
          set -euo pipefail

          for i in $(seq 1 60); do
            IP="$(kubectl -n ingress-nginx get svc ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || true)"
            if [ -n "${IP}" ]; then
              echo "origin_ip=${IP}" >> "$GITHUB_OUTPUT"
              echo "Origin IP: ${IP}"
              exit 0
            fi
            echo "Waiting for ingress external IP... (${i}/60)"
            sleep 10
          done

          echo "Ingress external IP not found" >&2
          exit 1

      - name: Determine record name (subdomain)
        id: rec
        run: |
          set -euo pipefail
          test -n "${WHOAMI_HOST}"

          # WHOAMI_HOST=bry.daviacandido.com.br -> record_name=bry
          RECORD_NAME="${WHOAMI_HOST%%.*}"
          echo "record_name=${RECORD_NAME}" >> "$GITHUB_OUTPUT"
          echo "Record name: ${RECORD_NAME}"

      - name: Upsert Cloudflare A record (proxied)
        run: |
          set -euo pipefail

          ORIGIN_IP="${{ steps.origin.outputs.origin_ip }}"
          RECORD_NAME="${{ steps.rec.outputs.record_name }}"
          ZONE_ID="${CLOUDFLARE_ZONE_ID}"

          test -n "${ORIGIN_IP}"
          test -n "${RECORD_NAME}"
          test -n "${ZONE_ID}"

          # 1) procurar record existente
          EXISTING_ID="$(curl -sS \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/dns_records?type=A&name=${WHOAMI_HOST}" \
            | python3 -c "import sys,json; d=json.load(sys.stdin); r=d.get('result',[]); print(r[0]['id'] if r else '')")"

          if [ -n "${EXISTING_ID}" ]; then
            echo "Updating existing record id=${EXISTING_ID} -> ${ORIGIN_IP}"
            curl -sS -X PATCH \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json" \
              "https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/dns_records/${EXISTING_ID}" \
              --data "{\"type\":\"A\",\"name\":\"${RECORD_NAME}\",\"content\":\"${ORIGIN_IP}\",\"ttl\":1,\"proxied\":true}" \
              | python3 -c "import sys,json; d=json.load(sys.stdin); print('success='+str(d.get('success'))); sys.exit(0 if d.get('success') else 1)"
          else
            echo "Creating new record ${WHOAMI_HOST} -> ${ORIGIN_IP}"
            curl -sS -X POST \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json" \
              "https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/dns_records" \
              --data "{\"type\":\"A\",\"name\":\"${RECORD_NAME}\",\"content\":\"${ORIGIN_IP}\",\"ttl\":1,\"proxied\":true}" \
              | python3 -c "import sys,json; d=json.load(sys.stdin); print('success='+str(d.get('success'))); sys.exit(0 if d.get('success') else 1)"
          fi

      - name: Show current DNS resolution (Cloudflare)
        run: |
          set -euo pipefail
          echo "dig ${WHOAMI_HOST} @1.1.1.1"
          dig +short "${WHOAMI_HOST}" @1.1.1.1 || true
