name: _logging

on:
  workflow_call:

permissions:
  contents: read

concurrency:
  group: k8s-logging
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: [self-hosted, jumpbox]
    defaults:
      run:
        shell: bash

    env:
      AKS_RESOURCE_GROUP: ${{ vars.aks_resource_group }}
      AKS_NAME: ${{ vars.aks_name }}

      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login (SP)
        run: |
          set -euo pipefail
          az login --service-principal \
            -u "${ARM_CLIENT_ID}" \
            -p "${ARM_CLIENT_SECRET}" \
            --tenant "${ARM_TENANT_ID}" >/dev/null
          az account set --subscription "${ARM_SUBSCRIPTION_ID}"

      - name: AKS credentials (admin)
        run: |
          set -euo pipefail
          rm -f ~/.kube/config || true
          az aks get-credentials \
            --resource-group "${AKS_RESOURCE_GROUP}" \
            --name "${AKS_NAME}" \
            --admin \
            --overwrite-existing

      - name: Apply Logging manifests (Loki + Promtail + Grafana datasource)
        run: |
          set -euo pipefail

          kubectl apply -f k8s/logging/00-namespace.yaml
          kubectl apply -f k8s/logging/10-loki.yaml
          kubectl apply -f k8s/logging/20-promtail.yaml

      - name: Wait logging components
        run: |
          set -euo pipefail

          # Loki pode ser StatefulSet ou Deployment dependendo do seu yaml
          kubectl -n logging get deploy,statefulset,daemonset -o wide || true

          if kubectl -n logging get deploy loki >/dev/null 2>&1; then
            kubectl -n logging rollout status deploy/loki --timeout=10m
          fi

          if kubectl -n logging get statefulset loki >/dev/null 2>&1; then
            kubectl -n logging rollout status statefulset/loki --timeout=10m
          fi

          if kubectl -n logging get daemonset promtail >/dev/null 2>&1; then
            kubectl -n logging rollout status daemonset/promtail --timeout=10m
          fi

          kubectl -n logging get pods,svc -o wide

      - name: Debug Loki service/endpoints
        if: always()
        run: |
          set -euo pipefail

          echo "=== Services (logging) ==="
          kubectl -n logging get svc -o wide || true

          echo "=== Endpoints (logging) ==="
          kubectl -n logging get endpoints -o wide || true

          echo "=== EndpointSlices (logging) ==="
          kubectl -n logging get endpointslices -o wide 2>/dev/null || true

          echo "=== Pods (logging) ==="
          kubectl -n logging get pods -o wide || true

      - name: Smoke test Loki (in-cluster)
        run: |
          set -euo pipefail

          # tenta descobrir o Service do Loki automaticamente
          SVC_NAME="$(kubectl -n logging get svc -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' | grep -E '^loki($|-)' | head -n1 || true)"
          if [[ -z "${SVC_NAME}" ]]; then
            echo "::error::Não encontrei Service do Loki no namespace logging (esperado algo como loki ou loki-*)"
            kubectl -n logging get svc -o wide || true
            exit 1
          fi

          # pega a primeira porta do Service (ou ajuste para escolher 3100 se existir)
          PORT="$(kubectl -n logging get svc "${SVC_NAME}" -o jsonpath='{.spec.ports[0].port}')"
          echo "Usando service=${SVC_NAME} port=${PORT}"

          # garante que o Service tem endpoints antes de testar curl
          if ! kubectl -n logging get endpoints "${SVC_NAME}" -o jsonpath='{.subsets[0].addresses[0].ip}' >/dev/null 2>&1; then
            echo "::error::Service ${SVC_NAME} sem endpoints (selector não bate ou pods não Ready)"
            kubectl -n logging describe svc "${SVC_NAME}" || true
            kubectl -n logging get endpoints "${SVC_NAME}" -o yaml || true
            kubectl -n logging get pods -o wide || true
            exit 1
          fi

          kubectl -n logging run --rm -i tmp-curl \
            --image=curlimages/curl:8.6.0 \
            --restart=Never -- \
            sh -lc "curl -sS -m 10 http://${SVC_NAME}.logging.svc.cluster.local:${PORT}/ready && echo OK"

